{% extends 'main.html' %}

{% block title %}
Виртуальный диспетчер
{% endblock %}

{% block body %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Список "Последние уведомления" -->
        <div class="col-md-3">
            <h5 class="mb-3">Последние уведомления</h5>
            <div class="list-group" style="max-height: 1000px; overflow-y: auto;">
                {% for alert in last_100_alerts %}
                <a href="{{ url_for('main.get_car', car_id=alert.uNumber) }}"
                   class="list-group-item list-group-item-action {% if alert.status == 1 %}list-group-item-secondary{% endif %}">
                    <div class="d-flex w-500 justify-content-between">
                        {% if alert.status %}
                            <h6 class="mb-1">{{ alert.uNumber }} (Решено)</h6>
                        {% else %}
                            <h6 class="mb-1">{{ alert.uNumber }}</h6>
                        {% endif %}
                        <small>{{ alert.date | unix_to_datetime }}</small>
                    </div>
                    <p class="mb-1 text-muted">
                        {% if alert.type == 'gps' %} Нет координат {{ alert.data }}
                        {% elif alert.type == 'distance' %} В {{ alert.data }} км от положенного места
                        {% elif alert.type == 'no_equipment' %} Нет оборудования {{ alert.data }}
                        {% elif alert.type == 'not_work' %} Оборудование {{ alert.data }} не в сети
                        {% else %} {{ alert.data }} {% endif %}
                    </p>
                </a>
                {% endfor %}
            </div>
        </div>

        <!-- Основной контент с карточками -->
        <div class="col-md-9">
            <div class="card p-4 shadow-lg rounded">
                <!-- Разделы и поиск -->
                <div class="d-flex justify-content-between mb-4">
                    <ul class="nav nav-pills" id="pills-tab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="pills-theft-tab" data-bs-toggle="pill" data-bs-target="#pills-theft" type="button" role="tab" aria-controls="pills-theft" aria-selected="true">Опасность угона ({{ distance|length }})</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pills-loss-tab" data-bs-toggle="pill" data-bs-target="#pills-loss" type="button" role="tab" aria-controls="pills-loss" aria-selected="false">Нерабочее оборудование ({{ not_work|length }})</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="pills-missing-equip-tab" data-bs-toggle="pill" data-bs-target="#pills-missing-equip" type="button" role="tab" aria-controls="pills-missing-equip" aria-selected="false">Отсутствие оборудования ({{ no_equipment|length }})</button>
                        </li>
                    </ul>

                    <!-- Поле поиска -->
                    <input type="text" class="form-control w-25" id="search-input" placeholder="Поиск по машинам">
                </div>

                <!-- Карточки -->
                <div class="tab-content" id="pills-tabContent" style="min-height: 1000px;">
                    <div class="tab-pane fade show active" id="pills-theft" role="tabpanel" aria-labelledby="pills-theft-tab">
                        <div class="row" id="theft-items">
                            {% for alert in distance %}
                            <div class="col-md-6 mb-4 card-wrapper">
                                <div class="card border-danger">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <h5 class="card-title"><a href="{{ url_for('main.get_car', car_id=alert.uNumber) }}" class="text-danger text-decoration-none">{{ alert.uNumber }}</a></h5>
                                            <small class="text-muted">{{ alert.date | unix_to_datetime }}</small>
                                        </div>
                                        <p class="card-text">
                                            {% if alert.type == 'gps' %} Нет координат от блока {{ alert.data }}
                                            {% elif alert.type == 'distance' %} ТС находится в {{ alert.data }} км от своего места работы
                                            {% else %} {{ alert.data }} {% endif %}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Нерабочее оборудование -->
                    <div class="tab-pane fade" id="pills-loss" role="tabpanel" aria-labelledby="pills-loss-tab">
                        <div class="row" id="not-work-items">
                            {% for alert in not_work %}
                            <div class="col-md-6 mb-4 card-wrapper">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <h5 class="card-title"><a href="{{ url_for('main.get_car', car_id=alert.uNumber) }}" class="text-primary text-decoration-none">{{ alert.uNumber }}</a></h5>
                                            <small class="text-muted">{{ alert.date | unix_to_datetime }}</small>
                                        </div>
                                        <p class="card-text">
                                            {% if alert.data == 'Wialon' %} Оборудование не выходило на связь больше 48 часов
                                            {% elif alert.data == 'Cesar' %} Оборудование не выходило на связь больше 3 дней
                                            {% else %} {{ alert.data }} {% endif %}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Отсутствие оборудования -->
                    <div class="tab-pane fade" id="pills-missing-equip" role="tabpanel" aria-labelledby="pills-missing-equip-tab">
                        <div class="row" id="missing-equip-items">
                            {% for alert in no_equipment %}
                            <div class="col-md-6 mb-4 card-wrapper">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <h5 class="card-title"><a href="{{ url_for('main.get_car', car_id=alert.uNumber) }}" class="text-primary text-decoration-none">{{ alert.uNumber }}</a></h5>
                                            <small class="text-muted">{{ alert.date | unix_to_datetime }}</small>
                                        </div>
                                        <p class="card-text">Нет оборудования {{ alert.data }}</p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const searchInput = document.getElementById('search-input');

    function filterItems() {
        const searchTerm = searchInput.value.toUpperCase();
        const activeTab = document.querySelector('.tab-pane.active');
        const items = Array.from(activeTab.querySelectorAll('.card-wrapper'));

        // Фильтруем элементы на основе ввода пользователя
        const filteredItems = items.filter(item => {
            const title = item.querySelector('.card-title').textContent.toUpperCase();
            return title.includes(searchTerm);
        });

        // Скрываем все элементы
        items.forEach(item => {
            item.style.display = 'none';
        });

        if (searchTerm) {
            // Если есть текст в поиске, показываем все подходящие элементы
            filteredItems.forEach(item => {
                item.style.display = 'block';
            });

            // Если ничего не найдено
            if (filteredItems.length === 0) {
                const container = document.querySelector(`#${activeTab.id}-items`);
                if (container) {
                    container.innerHTML = '<p class="text-muted">Нет результатов</p>';
                }
            }
        } else {
            // Если поиска нет, показываем все элементы
            items.forEach(item => {
                item.style.display = 'block';
            });
        }
    }

    searchInput.addEventListener('input', filterItems);

    // Обновление при переключении вкладок
    const tabs = document.querySelectorAll('.nav-link');
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            searchInput.value = ''; // Очищаем поле поиска
            filterItems(); // Обновляем результаты поиска
        });
    });
});
</script>

{% endblock %}
