<style>
    #my_map {
        width: 100%;
        height: 600px;
    }
</style>

<div class="container mt-5">
    <!-- Карта в карточке -->
    <div class="card mt-4">
        <div class="card-header">
            Маршрут ТС
        </div>
        <div class="card-body">
            <div class="row mb-3 align-items-end"> <!-- Добавлено align-items-end для выравнивания по нижнему краю -->
                <div class="col-md-5">
                    <label for="dateFrom">Дата и время от:</label>
                    <input type="datetime-local" class="form-control" id="dateFrom">
                </div>
                <div class="col-md-5">
                    <label for="dateTo">Дата и время до:</label>
                    <input type="datetime-local" class="form-control" id="dateTo">
                </div>
                <div class="col-md-2 d-flex align-items-end"> <!-- Используем d-flex для вертикального выравнивания -->
                    <button class="btn btn-primary w-100" id="applyBtn">Применить</button> <!-- Кнопка "Применить" занимает 100% ширины колонки -->
                </div>
            </div>
            <div id="my_map"></div> <!-- Изменено на my_map -->
        </div>
    </div>
</div>

<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
<script>
    let myMap;
    let historyData = [];

    // Инициализация карты
    ymaps.ready(init);

    function init() {
        myMap = new ymaps.Map("my_map", {
            center: [55.751574, 37.573856], // Координаты центра карты (Москва)
            zoom: 10
        });
    }

    // Логика для кнопки "Применить"
    document.getElementById('applyBtn').addEventListener('click', function () {
        const dateFrom = new Date(document.getElementById('dateFrom').value).getTime() / 1000; // Преобразование в Unix time
        const dateTo = new Date(document.getElementById('dateTo').value).getTime() / 1000; // Преобразование в Unix time
        const carName = "{{ car_name }}"; // Получаем значение из переменной car_name

        // Проверка на валидность выбранных дат
        if (isNaN(dateFrom) || isNaN(dateTo) || dateFrom >= dateTo) {
            alert('Пожалуйста, выберите корректные даты и время.');
            return;
        }

        // Отправка GET-запроса
        fetch(`/api/get_car_history?nm=${carName}&time_from=${dateFrom}&time_to=${dateTo}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }

                historyData = data; // Сохраняем полученные данные
                plotRouteAndMarkers(); // Отображаем маршрут и метки
            })
            .catch(error => console.error('Ошибка при получении истории передвижения:', error));
    });

    function plotRouteAndMarkers() {
        myMap.geoObjects.removeAll(); // Очищаем карту перед добавлением новых объектов

        const coordinates = historyData.map(entry => [entry.pos_y, entry.pos_x]); // Получаем координаты

        // Добавляем первую метку на карту
        if (coordinates.length > 0) {
            const firstPlacemark = new ymaps.Placemark(coordinates[0], {
                balloonContent: 'Начало маршрута'
            });
            myMap.geoObjects.add(firstPlacemark);
        }

        // Добавляем последнюю метку на карту и перемещаем карту к ней
        if (coordinates.length > 1) {
            const lastPlacemark = new ymaps.Placemark(coordinates[coordinates.length - 1], {
                balloonContent: 'Конец маршрута'
            });
            myMap.geoObjects.add(lastPlacemark);

            // Перемещаем карту к последней метке
            myMap.setCenter(coordinates[coordinates.length - 1], 12); // Масштаб карты на уровне 12
        }

        // Создаем линию и добавляем ее на карту
        if (coordinates.length > 1) {
            const line = new ymaps.GeoObject({
                geometry: {
                    type: 'LineString',
                    coordinates: coordinates
                },
                properties: {
                    hintContent: 'Маршрут',
                    balloonContent: 'Это линия маршрута'
                }
            }, {
                strokeWidth: 4,
                strokeColor: '#0000FF' // Цвет линии
            });
            myMap.geoObjects.add(line);
        }
    }
</script>


