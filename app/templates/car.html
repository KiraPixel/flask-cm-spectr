{% extends 'main.html' %}

{% block title %}
Карточка лота
{% endblock %}

{% block body %}
<div class="row mt-4">

</div>
<div class="container-xl mt-4">
    <div class="row">
        <div class="col">
            <h2>{{ car_name }}</h2>
            {% if wialon %}
                <p class="text-muted">{{ wialon[0].last_time | online_check }}</p>
            {% else %}
                <p class="text-muted">unknown</p>
            {% endif %}
        </div>
    </div>
    <div id="map" style="width: 100%; height: 400px;"></div>
    <br><br>
    <div class="row mt-4">
        <div class="col">
            <h4>Wialon</h4>
            <table class="table table-sm table-bordered">
                <thead class="thead-light">
                    <tr>
                        <th>Название объекта в системе</th>
                        <th>Последний онлайн</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in wialon %}
                    <tr>
                        <td>{{ item.nm }} | {{item.uid}}</td>
                        <td>{{ item.last_time | unix_to_datetime }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="col">
            <h4>Цезарь</h4>
            <table class="table table-sm table-bordered">
                <thead class="thead-light">
                    <tr>
                        <th>Название объекта в системе</th>
                        <th>Последний онлайн</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in cesar %}
                    <tr>
                        <td>{{ item.object_name }}</td>
                        <td>{{ item.last_time | unix_to_datetime }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <br><br>
    <div class="row mt-4">
        <div class="btn-group d-flex" role="group">
            <a href="#info" class="btn btn-outline-primary" id="info-tab">Инфо</a>
            <a href="#sensors" class="btn btn-outline-primary" id="sensors-tab">Датчики</a>
            <a href="#transitions" class="btn btn-outline-primary" id="transitions-tab">Переходы</a>
            <a href="#comments" class="btn btn-outline-primary" id="comments-tab">Комментарии</a>
        </div>
    </div>
    <div class="row mt-3">
        <div class="tab-content" id="tab-content">
            <div class="tab-pane" id="info-content">
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3>Информация о складе</h3>
                            </div>
                            <div class="card-body">
                                <p><strong>Название:</strong> {{ storage.name }}</p>
                                <p><strong>Тип:</strong> {{ storage.type }}</p>
                                <p><strong>Регион:</strong> {{ storage.region }}</p>
                                <p><strong>Адрес:</strong> {{ storage.address }}</p>
                                <p><strong>Организация:</strong> {{ storage.organization }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3>Модель транспортного средства</h3>
                            </div>
                            <div class="card-body">
                                <p><strong>Тип:</strong> {{ transport_model.type }} - {{ transport_model.name }}</p>
                                <p><strong>Год выпуска:</strong> {{ car.manufacture_year }} ({{ transport_model.country }})</p>
                                <p><strong>VIN:</strong> {{ car.vin }}</p>
                                <p><strong>Лифт:</strong> {{ transport_model.lift_type }}</p>
                                <p><strong>Двигатель:</strong> {{ transport_model.engine }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane" id="sensors-content">
                <h3>Датчики</h3>
                <div class="alert alert-info" role="alert">
                    Данный раздел в разработке и скоро будет работать. Мы работаем над добавлением информации и функционала.
                </div>

                <!-- Графики -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h4>Время работы по дням</h4>
                        <canvas id="work-time-chart" width="400" height="200"></canvas>
                    </div>
                    <div class="col-md-6">
                        <h4>Километраж</h4>
                        <canvas id="mileage-chart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- Реле датчиков -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h4>Реле датчиков</h4>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="sunroof-open" disabled>
                            <label class="form-check-label" for="sunroof-open">
                                Люк открыт
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="sunroof-closed" disabled>
                            <label class="form-check-label" for="sunroof-closed">
                                Люк закрыт
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Кнопки -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h4>Действия</h4>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-primary disabled">Заблокировать двигатель</button>
                            <button type="button" class="btn btn-primary disabled">Перезапустить Wialon</button>
                            <button type="button" class="btn btn-primary disabled">Выполнить GSM поиск CESAR и Wialon</button>
                        </div>
                    </div>
                </div>
            </div>
                        <!-- Подключение Chart.js -->
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script type="text/javascript">
                // Пример данных для графиков
                const workTimeData = {
                    labels: ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'],
                    datasets: [{
                        label: 'Время работы (часы)',
                        data: [8, 7, 8, 6, 8, 5, 4],
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                };

                const mileageData = {
                    labels: ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн', 'Июл'],
                    datasets: [{
                        label: 'Километраж (км)',
                        data: [1200, 1100, 1150, 1300, 1250, 1400, 1350],
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                };

                // Инициализация графиков
                const ctxWorkTime = document.getElementById('work-time-chart').getContext('2d');
                const workTimeChart = new Chart(ctxWorkTime, {
                    type: 'bar',
                    data: workTimeData,
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                const ctxMileage = document.getElementById('mileage-chart').getContext('2d');
                const mileageChart = new Chart(ctxMileage, {
                    type: 'line',
                    data: mileageData,
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            </script>

        <div class="tab-pane" id="transitions-content">
            <h3>Переходы</h3>
            <div class="alert alert-info" role="alert">
                Данный раздел в разработке и скоро будет работать. Мы работаем над добавлением информации и функционала.
            </div>

            <!-- Таблица переходов -->
            <div class="table-responsive mt-4">
                <table class="table table-sm table-bordered">
                    <thead class="thead-light">
                        <tr>
                            <th>Дата перехода</th>
                            <th>Тип ТС</th>
                            <th>Склад (Источник)</th>
                            <th>Склад (Цель)</th>
                            <th>Автор</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Пример строк, можно заменить динамическими данными -->
                        <tr>
                            <td>2024-07-28</td>
                            <td>Тип 1</td>
                            <td>Склад A</td>
                            <td>Склад B</td>
                            <td>Иван Иванов</td>
                        </tr>
                        <tr>
                            <td>2024-07-30</td>
                            <td>Тип 2</td>
                            <td>Склад B</td>
                            <td>Склад C</td>
                            <td>Петр Петров</td>
                        </tr>
                        <!-- Динамические строки будут вставляться здесь -->
                    </tbody>
                </table>
            </div>

            <!-- Кнопка переноса ТС -->
            <div class="mt-4">
                <button type="button" class="btn btn-primary disabled">Перенести ТС на другой склад</button>
            </div>
        </div>

<div class="tab-pane" id="comments-content">
    <h3>Комментарии</h3>
    <div class="alert alert-info" role="alert">
        Данный раздел в разработке и скоро будет работать. Мы работаем над добавлением информации и функционала.
    </div>

    <!-- Комментарии -->
    <div class="mt-4">
        <h4>Список комментариев</h4>
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">Иван Иванов</h5>
                <h6 class="card-subtitle mb-2 text-muted">2024-07-28</h6>
                <p class="card-text">Комментарий 1</p>
                <a href="#" class="btn btn-secondary btn-sm disabled">Посмотреть файл</a>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">Петр Петров</h5>
                <h6 class="card-subtitle mb-2 text-muted">2024-07-29</h6>
                <p class="card-text">Комментарий 2</p>
                <a href="#" class="btn btn-secondary btn-sm disabled">Посмотреть файл</a>
            </div>
        </div>

        <!-- Дополнительные карточки комментариев будут добавляться здесь -->
    </div>

    <!-- Форма для добавления комментария -->
    <div class="mt-4">
        <h4>Добавить комментарий</h4>
        <form>
            <div class="form-group">
                <label for="commentText">Комментарий</label>
                <textarea id="commentText" class="form-control" rows="3" placeholder="Введите ваш комментарий" disabled></textarea>
            </div>
            <div class="form-group">
                <label for="commentFile">Прикрепить файл</label>
                <input type="file" id="commentFile" class="form-control-file" disabled>
            </div>
            <button type="submit" class="btn btn-primary" disabled>Добавить комментарий</button>
        </form>
    </div>
</div>



        </div>
    </div>
</div>

<!-- Подключение Yandex Map без API ключа -->
<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
<script type="text/javascript">
    ymaps.ready(init);
    function init(){
        var myMap = new ymaps.Map("map", {
            center: [60, 80],
            zoom: 3
        });

        // Добавление метки "Место работы", если car.x != 0
        {% if car.x != 0 %}
        var workPlaceMark = new ymaps.Placemark([{{ car.x }}, {{ car.y }}], {
            hintContent: 'Место работы',
            balloonContent: 'Здесь работает автомобиль'
        },
        {
            preset: 'islands#yellowIcon'
        });
        myMap.geoObjects.add(workPlaceMark);
        {% endif %}

        // Добавление меток Cesar
        {% for item in cesar %}
        var cesarMark = new ymaps.Placemark([{{ item.pos_x }}, {{ item.pos_y }}], {
            hintContent: 'Метка Cesar',
            balloonContent: 'UID блока: {{ item.object_name }}'
        },
        {
            preset: 'islands#redIcon'
        });
        myMap.geoObjects.add(cesarMark);
        {% endfor %}

        // Добавление меток Wialon
        {% for item in wialon %}
        var wialonMark = new ymaps.Placemark([{{ item.pos_y }}, {{ item.pos_x }}], {
            hintContent: 'Метка Wialon ',
            balloonContent: 'UUID блока: {{ item.nm }}'
        });
        myMap.geoObjects.add(wialonMark);
        {% endfor %}
    }

    document.addEventListener('DOMContentLoaded', function () {
        const tabs = document.querySelectorAll('.btn-group .btn');
        const tabContent = document.querySelectorAll('.tab-pane');

        function showTab(tab) {
            tabs.forEach(tab => {
                tab.classList.remove('btn-primary');
                tab.classList.add('btn-outline-primary');
            });

            tab.classList.remove('btn-outline-primary');
            tab.classList.add('btn-primary');

            const tabName = tab.getAttribute('href').substring(1);
            tabContent.forEach(content => {
                if (content.getAttribute('id') === `${tabName}-content`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        tabs.forEach(tab => {
            tab.addEventListener('click', function (e) {
                e.preventDefault();
                showTab(tab);
                window.location.hash = tab.getAttribute('href');
            });
        });

        // Initial tab based on hash
        const currentHash = window.location.hash || '#info';
        const initialTab = document.querySelector(`.btn[href="${currentHash}"]`);
        if (initialTab) {
            showTab(initialTab);
        }
    });
</script>
{% endblock %}
